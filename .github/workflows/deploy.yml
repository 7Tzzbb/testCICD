name: Next.js Static Export and Deploy  # å·¥ä½œæµåç§°ï¼šç”¨äº Next.js é¡¹ç›®çš„æ„å»ºå’Œéƒ¨ç½²

on:
  push:
    branches:
      - main  # ä»…å½“ä»£ç æ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘å·¥ä½œæµ

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest  # ä½¿ç”¨æœ€æ–°ç‰ˆ Ubuntu ä½œä¸ºè¿è¡Œç¯å¢ƒ

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        # ç¬¬ä¸€æ­¥ï¼šæ‹‰å–å½“å‰ä»“åº“çš„ä»£ç åˆ° GitHub Actions runner ç¯å¢ƒ

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
        # ç¬¬äºŒæ­¥ï¼šå®‰è£…æŒ‡å®šç‰ˆæœ¬çš„ Node.jsï¼ˆè¿™é‡Œæ˜¯ v18ï¼‰

      - name: Install pnpm
        run: npm install -g pnpm
        # ç¬¬ä¸‰æ­¥ï¼šå…¨å±€å®‰è£… pnpmï¼Œä½œä¸ºåŒ…ç®¡ç†å·¥å…·

      - name: Install dependencies
        run: pnpm install
        # ç¬¬å››æ­¥ï¼šä½¿ç”¨ pnpm å®‰è£…é¡¹ç›®ä¾èµ–ï¼ˆä¼šæ ¹æ® pnpm-lock.yaml å®‰è£…ç²¾å‡†ä¾èµ–ï¼‰

      - name: Build & Export Next.js static site
        run: |
          pnpm run build        # æ„å»º Next.js é¡¹ç›®ï¼Œç”Ÿæˆ .next ç›®å½•

      - name: List files in out directory for debugging
        run: ls -la ./out
        # ç¬¬å…­æ­¥ï¼šåˆ—å‡º out ç›®å½•å†…å®¹ï¼Œç”¨äºè°ƒè¯•ç¡®è®¤é™æ€æ–‡ä»¶æ˜¯å¦æ­£ç¡®ç”Ÿæˆ

      - name: Deploy `out` folder content to server with SSH key
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DEPLOY_HOST }}         # ç›®æ ‡æœåŠ¡å™¨ IP æˆ–åŸŸåï¼ˆä¿å­˜åœ¨ GitHub Secrets ä¸­ï¼‰
          username: ${{ secrets.DEPLOY_USER }}     # SSH ç”¨æˆ·å
          key: ${{ secrets.SSH_PRIVATE_KEY }}      # SSH ç§é’¥ï¼ˆç”¨äºå…å¯†ç™»å½•ï¼‰
          port: 22                                 # SSH ç«¯å£ï¼ˆé»˜è®¤ 22ï¼‰
          source: "./out/*"                        # ğŸ‘ˆ åªä¸Šä¼  out æ–‡ä»¶å¤¹ä¸‹çš„æ‰€æœ‰å†…å®¹
          target: "/home/wwwroot/www.next.com/"    # ğŸ‘ˆ ç›´æ¥æ”¾è¿›æŒ‡å®šç›®æ ‡è·¯å¾„ï¼ˆä¸ä¼šå¤šä¸€å±‚ outï¼‰
        # ç¬¬ä¸ƒæ­¥ï¼šä½¿ç”¨ scp å°† out ç›®å½•ä¸‹çš„å†…å®¹ä¸Šä¼ è‡³æœåŠ¡å™¨æŒ‡å®šè·¯å¾„ï¼Œå®Œæˆéƒ¨ç½²
